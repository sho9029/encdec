# encdec v2.0 技術仕様書

本ドキュメントは、`encdec` v2.0 の設計詳細、および旧バージョン（v1.x）からの変更点と課題解決について定義するものです。

---

## 1. はじめに
`encdec` v2.0 は、従来の XOR 暗号ツールが抱えていたキーストリームの周期性や鍵衝突、およびエラー検知の欠如という課題を解決するために設計されました。最大の特徴は、オンザフライ方式の広帯域エンジンと、完全性検証用のフッター導入にあります。

---

## 2. v2.0 仕様詳細 (Current Specification)

### 2.1 広帯域ステートエンジン (Wide State Engine)
キーストリーム生成の核心として、64bit 整数一律の制約を排した設計を採用。
- **ステート初期化**: 入力鍵を 512bit 以上の `std::vector<uint64_t>` ステート配列に直接吸収。文字列変換（`to_string`）を介さず、バイナリデータとして情報を保持。
- **撹乱演算 (ARX)**: 加算 (Addition)、回転 (Rotation)、XOR を組み合わせた混合関数により、ステートを高密度に撹乱。
- **非周期性の確保**: 常に「ファイル位置（Position）」と「大域的な塩（Global Salt）」を演算に組み込み、同一鍵でも位置が異なれば全く異なるバイトを出力。これにより Kasiski テスト等の統計的攻撃を無効化。

### 2.2 データ完全性と改ざん検知
復号時に「正しい鍵が入力されたか」を即座に判断する仕組み。
- **整合性ハッシュ**: 暗号化プロセスと同時に、平文の全バイト情報を 64bit の内部ステートへ反映。
- **フッターの記録**: 暗号化終了後、計算された最終ハッシュをファイル末尾に付与。
- **検証プロセス**: 復号中に同様のハッシュを算出し、ファイル末尾の記録と照合。1ビットでも不一致があれば「Decryption failed」として即座に中断。

### 2.3 ファイルフォーマット
| セクション | 構造 | 内容 |
| :--- | :--- | :--- |
| **ヘッダー** (5B) | ID(3B) + Ver(2B) | `45 44 FF 02 00` |
| **ペイロード** | (可変) | バイト回転 XOR 適用済みデータ |
| **フッター** (8B) | Hash(8B) | `uint64_t` 型の整合性検証用ハッシュ |

---

## 3. 旧バージョン (v1.x) の仕様と脆弱性 (Legacy)

v1.3 以下では以下のロジックが使用されていました。

### 3.1 鍵生成ロジック (`stoiorder`)
$$Seed = \sum_{j=0}^{n} (VID_{char[j]} \times 1.1^j)$$
- **課題**: `double` 型の演算と `pow` 関数に依存しており、鍵が長くなると浮動小数点の精度限界により、異なる鍵が同一のシードに収束（衝突）するリスクがありました。

### 3.2 暗号化プロセスと周期性
$$C_i = P_i \oplus spkey[i \pmod{L}]$$
- **課題**: シードを元に生成した固定長バッファ（`spkey`）を繰り返すため、バッファ長 $L$ ごとにキーストリームがループし、パターン解析の余地を与えていました。

---

## 4. 互換性の維持
v2.0 は、ヘッダーのバージョン番号を読み取り、`0x01 0x03` (v1.3) を検知した場合は自動的に旧アルゴリズムでの復号（Legacy Mode）を開始します。このロジックは `LegacyDecoder` クラスに完全に隔離されており、新設計の実装を汚染しません。

---

## 5. 安全性・利便性の改善項目
- **パスバリデーション**: `NUL` デバイス等への不正な書き込みを防ぐため、`std::filesystem` による入力・出力パスの厳密な検証を実施。
- **UI/UX**: `system("pause")` といった外部コマンド依存を排除し、`std::cin.get()` によるセキュアな待機処理へ移行。
- **エラーメッセージ**: 失敗した「結果」だけでなく、「なぜ失敗したか（ファイル不在、パスワード不一致、アクセス権限等）」を明示する「原因究明型」の出力を実装。

---
**作成日**: 2026-01-04
**プロジェクト名**: encdec (XOR Stream Cipher Study)
